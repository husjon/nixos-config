#!/usr/bin/env bash

set -e

FILE=${1}

if [ ! "${FILE}" ]; then
	echo -e "Usage:\n $(basename "${0}") <path>"
	exit 1
fi

ORIGINAL_FILE=$(readlink "${FILE}" || echo "")
ORIGINAL_FILE_CANONICALIZED=$(readlink --canonicalize "${FILE}" || echo "")
TMP_FILE=$(mktemp)

# Once editor or terminal is closed, reinstate the symlink
function cleanup() {
	ln -sf "${ORIGINAL_FILE}" "${FILE}"
	rm -f "${TMP_FILE}"
}
trap cleanup EXIT TERM INT HUP

if ! echo "${ORIGINAL_FILE}" | grep -E '^/nix/store/.*?-home-manager-files/' >/dev/null; then
	echo "File \"${FILE}\" is not managed by home-manager"
	exit 1
fi

# Copy the canonicalized file to tmp for editing and make it writable
cp --preserve=mode "${ORIGINAL_FILE_CANONICALIZED}" "${TMP_FILE}"
chmod +w "${TMP_FILE}"

# Replace the link to the file we're editing
ln -fs "${TMP_FILE}" "${FILE}"

# Edit the file with the user specified EDITOR
${EDITOR} "${FILE}"
